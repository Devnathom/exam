generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN
  SCHOOL_ADMIN
  TEACHER
  SCANNER_OPERATOR
}

enum ExamStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model School {
  id        String   @id @default(uuid()) @db.Uuid
  name      String   @db.VarChar(255)
  code      String   @unique @db.VarChar(50)
  address   String?  @db.Text
  phone     String?  @db.VarChar(20)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  users        User[]
  students     Student[]
  exams        Exam[]
  answerSheets AnswerSheet[]
  results      Result[]

  @@index([code])
  @@index([isActive])
  @@map("schools")
}

model User {
  id             String   @id @default(uuid()) @db.Uuid
  schoolId       String?  @map("school_id") @db.Uuid
  email          String   @unique @db.VarChar(255)
  password       String   @db.VarChar(255)
  firstName      String   @map("first_name") @db.VarChar(100)
  lastName       String   @map("last_name") @db.VarChar(100)
  role           Role     @default(TEACHER)
  isActive       Boolean  @default(true) @map("is_active")
  refreshToken   String?  @map("refresh_token") @db.Text
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  deletedAt      DateTime? @map("deleted_at")

  school School? @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@index([email])
  @@index([role])
  @@map("users")
}

model Student {
  id          String   @id @default(uuid()) @db.Uuid
  schoolId    String   @map("school_id") @db.Uuid
  studentCode String   @map("student_code") @db.VarChar(20)
  firstName   String   @map("first_name") @db.VarChar(100)
  lastName    String   @map("last_name") @db.VarChar(100)
  classroom   String   @db.VarChar(50)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  school       School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  answerSheets AnswerSheet[]
  results      Result[]

  @@unique([schoolId, studentCode])
  @@index([schoolId])
  @@index([studentCode])
  @@index([classroom])
  @@map("students")
}

model Exam {
  id              String     @id @default(uuid()) @db.Uuid
  schoolId        String     @map("school_id") @db.Uuid
  title           String     @db.VarChar(255)
  description     String?    @db.Text
  subject         String     @db.VarChar(100)
  totalQuestions   Int        @map("total_questions")
  choicesPerQuestion Int     @default(4) @map("choices_per_question")
  status          ExamStatus @default(DRAFT)
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")
  deletedAt       DateTime?  @map("deleted_at")

  school       School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  questions    Question[]
  examVersions ExamVersion[]
  answerSheets AnswerSheet[]
  results      Result[]

  @@index([schoolId])
  @@index([status])
  @@index([subject])
  @@map("exams")
}

model Question {
  id             String   @id @default(uuid()) @db.Uuid
  examId         String   @map("exam_id") @db.Uuid
  questionNumber Int      @map("question_number")
  content        String   @db.Text
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  exam    Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  choices Choice[]

  @@unique([examId, questionNumber])
  @@index([examId])
  @@map("questions")
}

model Choice {
  id         String  @id @default(uuid()) @db.Uuid
  questionId String  @map("question_id") @db.Uuid
  label      String  @db.VarChar(5)
  content    String  @db.Text
  isCorrect  Boolean @default(false) @map("is_correct")

  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
  @@map("choices")
}

model ExamVersion {
  id                  String   @id @default(uuid()) @db.Uuid
  examId              String   @map("exam_id") @db.Uuid
  versionCode         String   @map("version_code") @db.VarChar(5)
  questionMapping     Json     @map("question_mapping") @db.JsonB
  choiceMapping       Json     @map("choice_mapping") @db.JsonB
  answerKey           Json     @map("answer_key") @db.JsonB
  createdAt           DateTime @default(now()) @map("created_at")

  exam         Exam          @relation(fields: [examId], references: [id], onDelete: Cascade)
  answerSheets AnswerSheet[]
  results      Result[]

  @@unique([examId, versionCode])
  @@index([examId])
  @@index([versionCode])
  @@map("exam_versions")
}

model AnswerSheet {
  id            String   @id @default(uuid()) @db.Uuid
  schoolId      String   @map("school_id") @db.Uuid
  examId        String   @map("exam_id") @db.Uuid
  examVersionId String?  @map("exam_version_id") @db.Uuid
  studentId     String?  @map("student_id") @db.Uuid
  studentCode   String?  @map("student_code") @db.VarChar(20)
  answers       Json?    @db.JsonB
  imageUrl      String?  @map("image_url") @db.Text
  isProcessed   Boolean  @default(false) @map("is_processed")
  scannedAt     DateTime? @map("scanned_at")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  school      School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  exam        Exam         @relation(fields: [examId], references: [id], onDelete: Cascade)
  examVersion ExamVersion? @relation(fields: [examVersionId], references: [id])
  student     Student?     @relation(fields: [studentId], references: [id])
  result      Result?

  @@index([schoolId])
  @@index([examId])
  @@index([studentCode])
  @@index([isProcessed])
  @@map("answer_sheets")
}

model Result {
  id            String   @id @default(uuid()) @db.Uuid
  schoolId      String   @map("school_id") @db.Uuid
  examId        String   @map("exam_id") @db.Uuid
  examVersionId String   @map("exam_version_id") @db.Uuid
  studentId     String   @map("student_id") @db.Uuid
  answerSheetId String   @unique @map("answer_sheet_id") @db.Uuid
  score         Int
  totalQuestions Int     @map("total_questions")
  percentage    Float
  details       Json     @db.JsonB
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  school      School      @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  exam        Exam        @relation(fields: [examId], references: [id], onDelete: Cascade)
  examVersion ExamVersion @relation(fields: [examVersionId], references: [id])
  student     Student     @relation(fields: [studentId], references: [id])
  answerSheet AnswerSheet @relation(fields: [answerSheetId], references: [id])

  @@unique([examId, studentId])
  @@index([schoolId])
  @@index([examId])
  @@index([studentId])
  @@index([percentage])
  @@map("results")
}
